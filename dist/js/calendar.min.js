angular.module("ui.rCalendar",[]).constant("calendarConfig",{formatDay:"dd",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",calendarMode:"month",showWeeks:!1,showEventDetail:!0,startingDay:0,eventSource:null,queryMode:"local",showTitle:!0,hideWeekend:!1}).controller("CalendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","calendarConfig",function(a,b,c,d,e,f,g){"use strict";function h(a,b){return a.endIndex<=b.startIndex||b.endIndex<=a.startIndex?!1:!0}function i(a){var b,c,d,e=a.length,f=0,g=new Array(e);for(b=0;e>b;b+=1){for(d=0;f>d;d+=1)g[d]=!1;for(c=0;b>c;c+=1)h(a[b],a[c])&&(g[a[c].position]=!0);for(d=0;f>d&&g[d];d+=1);f>d?a[b].position=d:a[b].position=f++}}function j(a){var b,c,d,e,f,g,h,i=new Array(24);for(a.sort(function(a,b){return b.position-a.position}),d=0;24>d;d+=1)i[d]={calculated:!1,events:[]};for(f=a.length,d=0;f>d;d+=1)for(b=a[d],c=b.startIndex;c<b.endIndex;)i[c].events.push(b),c+=1;for(d=0;f>d;){if(b=a[d],!b.overlapNumber){var j=b.position+1;b.overlapNumber=j;for(var k=[b];b=k.shift();)for(c=b.startIndex;c<b.endIndex;){if(!i[c].calculated&&(i[c].calculated=!0,i[c].events))for(g=i[c].events.length,e=0;g>e;e+=1)h=i[c].events[e],h.overlapNumber||(h.overlapNumber=j,k.push(h));c+=1}}d+=1}}var k=this,l={$setViewValue:angular.noop};angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","showWeeks","showEventDetail","startingDay","eventSource","queryMode"],function(c,e){k[c]=angular.isDefined(b[c])?5>e?d(b[c])(a.$parent):a.$parent.$eval(b[c]):g[c]}),a.$parent.$watch("eventSource",function(a){k.onEventSourceChanged(a)}),a.calendarMode=a.calendarMode||g.calendarMode,angular.isDefined(b.initDate)&&(k.currentCalendarDate=a.$parent.$eval(b.initDate)),k.currentCalendarDate||(k.currentCalendarDate=new Date,b.ngModel&&!a.$parent.$eval(b.ngModel)&&c(b.ngModel).assign(a.$parent,k.currentCalendarDate)),k.init=function(a){l=a,l.$render=function(){k.render()}},k.render=function(){if(l.$modelValue){var a=new Date(l.$modelValue),b=!isNaN(a);b?this.currentCalendarDate=a:e.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),l.$setValidity("date",b)}this.refreshView()},k.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),this._refreshView(),this.rangeChanged())},k.split=function(a,b){for(var c=[];a.length>0;)c.push(a.splice(0,b));return c},k.onEventSourceChanged=function(a){k.eventSource=a,k._onDataLoaded&&k._onDataLoaded()},a.move=function(b){var c,d=k.mode.step,e=k.currentCalendarDate,f=e.getFullYear()+b*(d.years||0),g=e.getMonth()+b*(d.months||0),h=e.getDate()+b*(d.days||0);e.setFullYear(f,g,h),"month"===a.calendarMode&&(c=new Date(f,g+1,1),c.getTime()<=e.getTime()&&(k.currentCalendarDate=new Date(c-864e5))),l.$setViewValue(k.currentCalendarDate),k.refreshView()},k.move=function(b){a.move(b)},k.rangeChanged=function(){"local"===k.queryMode?k.eventSource&&k._onDataLoaded&&k._onDataLoaded():"remote"===k.queryMode&&a.rangeChanged&&a.rangeChanged({startTime:this.range.startTime,endTime:this.range.endTime})},k.placeEvents=function(a){i(a),j(a)},k.placeAllDayEvents=function(a){i(a)}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/calendar.html",scope:{calendarMode:"=",eventsTypes:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&",showTitle:"=",hideWeekend:"=",allDayTitle:"@",noEventsTitle:"@",timeMode:"@",dayStart:"@",dayEnd:"@",hideAllday:"="},require:["calendar","?^ngModel"],controller:"CalendarController",link:function(a,b,c,d){var e=d[0],f=d[1];f&&e.init(f),a.$on("changeDate",function(a,b){e.move(b)}),a.$on("eventSourceChanged",function(a,b){e.onEventSourceChanged(b)})}}}).directive("monthview",["dateFilter",function(a){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/month.html",require:["^calendar","?^ngModel"],link:function(b,c,d,e){function f(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);b>e;)c[e++]=new Date(d),d.setDate(d.getDate()+1);return c}function g(b,c){return{date:b,label:a(b,c),selected:0===j.compare(b,j.currentCalendarDate),current:0===j.compare(b,new Date)}}function h(a,b){return a.allDay?1:b.allDay?-1:a.startTime.getTime()-b.startTime.getTime()}function i(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}var j=e[0],k=e[1];b.showWeeks=j.showWeeks,b.showEventDetail=j.showEventDetail,b.hasEventsWithType=function(a){if(void 0===b.selectedDate.events)return!1;var c=!1,d=b.selectedDate.events;return d.forEach(function(b){b.type===a&&(c=!0)},this),c},j.mode={step:{months:1}},b.select=function(a){var c=b.rows;if(c){var d=j.currentCalendarDate,e=d.getMonth(),f=d.getFullYear(),g=a.getMonth(),h=a.getFullYear(),i=0;if(f===h?e!==g&&(i=g>e?1:-1):i=h>f?1:-1,j.currentCalendarDate=a,k&&k.$setViewValue(a),0===i)for(var l=0;6>l;l+=1)for(var m=0;7>m;m+=1){var n=0===j.compare(a,c[l][m].date);c[l][m].selected=n,n&&(b.selectedDate=c[l][m])}else j.refreshView();b.timeSelected&&b.timeSelected({selectedTime:a})}},j._refreshView=function(){for(var c=j.range.startTime,d=c.getDate(),e=(c.getMonth()+(1!==d?1:0))%12,h=c.getFullYear()+(1!==d&&0===e?1:0),k=f(c,42),l=0;42>l;l++)k[l]=angular.extend(g(k[l],j.formatDay),{secondary:k[l].getMonth()!==e});b.labels=new Array(7);for(var m=0;7>m;m++)b.labels[m]=a(k[m].date,j.formatDayHeader);var n=new Date(h,e,1);if(b.$parent.title=a(n,j.formatMonthTitle),b.rows=j.split(k,7),b.showWeeks){b.weekNumbers=[];for(var o=i(b.rows[0][0].date),p=b.rows.length,q=0;p>q;)q=b.weekNumbers.push(o),o+=1}},j._onDataLoaded=function(){var a,c,d=j.eventSource,e=d?d.length:0,f=j.range.startTime,g=j.range.endTime,i=-(new Date).getTimezoneOffset(),k=new Date(f.getTime()+6e4*i),l=new Date(g.getTime()+6e4*i),m=b.rows,n=864e5,o=.001,p=!1;if(m.hasEvent)for(a=0;6>a;a+=1)for(c=0;7>c;c+=1)m[a][c].hasEvent&&(m[a][c].events=null,m[a][c].hasEvent=!1);for(var q=0;e>q;q+=1){var r,s,t=d[q],u=new Date(t.startTime),v=new Date(t.endTime);if(t.allDay){if(k>=v||u>=l)continue;r=k,s=l}else{if(f>=v||u>=g)continue;r=f,s=g}var w;w=r>=u?0:(u-r)/n;var x;x=v>=s?(s-r)/n:(v-r)/n;for(var y,z=Math.floor(w);x-o>z;){var A=Math.floor(z/7),B=Math.floor(z%7);m[A][B].hasEvent=!0,y=m[A][B].events,y?y.push(t):(y=[],y.push(t),m[A][B].events=y),z+=1}}for(a=0;6>a;a+=1)for(c=0;7>c;c+=1)m[a][c].hasEvent&&(p=!0,m[a][c].events.sort(h));m.hasEvent=p;var C=!1;for(a=0;6>a;a+=1){for(c=0;7>c;c+=1)if(m[a][c].selected){b.selectedDate=m[a][c],C=!0;break}if(C)break}},j.compare=function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate())-new Date(b.getFullYear(),b.getMonth(),b.getDate())},j._getRange=function(a){var b,c=a.getFullYear(),d=a.getMonth(),e=new Date(c,d,1),f=j.startingDay-e.getDay(),g=f>0?7-f:-f,h=new Date(e);return g>0&&h.setDate(-g+1),b=new Date(h),b.setDate(b.getDate()+42),{startTime:h,endTime:b}},j.refreshView()}}}]).directive("weekview",["dateFilter","$timeout",function(a,b){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/week.html",require:"^calendar",link:function(c,d,e,f){function g(){var a=d.children(),b=a[1].children[1],e=b.offsetWidth-b.clientWidth,f=a[2],g=f.offsetWidth-f.clientWidth,h=e||g||0;h>0&&(c.gutterWidth=h,0>=e?c.allDayEventGutterWidth=h:c.allDayEventGutterWidth=0,0>=g?c.normalGutterWidth=h:c.normalGutterWidth=0)}function h(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);b>e;)c[e++]={date:new Date(d)},d.setDate(d.getDate()+1);return c}function i(a){for(var b,d=[],e=new Date(a.getTime()),f=e.getHours(),g=e.getDate(),h=k;l>=h;h+=1){b=[];for(var i=c.hideWeekend===!0?1:0,j=c.hideWeekend===!0?6:7,m=i;j>m;m+=1)e.setHours(f+h),e.setDate(g+m),b.push({time:new Date(e.getTime())});d.push(b)}return d}function j(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}var k=c.dayStart&&parseInt(c.dayStart,10)?parseInt(c.dayStart,10):0,l=c.dayEnd&&parseInt(c.dayEnd,10)?parseInt(c.dayEnd,10):23;b(function(){g()}),f.mode={step:{days:7}},f._onDataLoaded=function(){var a,d,e,h=f.eventSource,i=h?h.length:0,j=f.range.startTime,m=f.range.endTime,n=-(new Date).getTimezoneOffset(),o=new Date(j.getTime()+60*n*1e3),p=new Date(m.getTime()+60*n*1e3),q=c.rows,r=c.dates,s=36e5,t=864e5,u=.016,v=!1,w=!1;if(q.hasEvent){for(d=0;7>d;d+=1)for(e=k;l>=e;e+=1)q[e]&&q[e][d]&&q[e][d].events&&(q[e][d].events=null);q.hasEvent=!1}if(r.hasEvent){for(d=0;7>d;d+=1)r[d]&&r[d].events&&(r[d].events=null);r.hasEvent=!1}for(var x=0;i>x;x+=1){var y=h[x],z=new Date(y.startTime),A=new Date(y.endTime);if(y.allDay){if(o>=A||z>=p)continue;v=!0;var B;B=o>=z?0:Math.floor((z-o)/t);var C;C=A>=p?Math.ceil((p-o)/t):Math.ceil((A-o)/t);var D={event:y,startIndex:B,endIndex:C};a=r[B].events,a?a.push(D):(a=[],a.push(D),r[B].events=a)}else{if(j>=A||z>=m)continue;w=!0;var E;E=j>=z?0:(z-j)/s;var F;F=A>=m?(m-j)/s:(A-j)/s;var G,H=Math.floor(E),I=Math.ceil(F-u),J=H%24,K=Math.floor(H/24),L=24*K;do{L+=24,G=I>=L?24:I%24;var M={event:y,startIndex:J-k,endIndex:G-k};a=q[J-k]?q[J-k][K].events:null,a?a.push(M):q[J-k]&&(a=[],a.push(M),q[J-k][K].events=a),J=0,K+=1}while(I>L)}}if(w)for(d=0;7>d;d+=1){var N=[];for(e=k;l>=e;e+=1)q[e]&&q[e][d]&&q[e][d].events&&(N=N.concat(q[e][d].events));N.length>0&&(q.hasEvent=!0,f.placeEvents(N))}if(v){var O=[];for(d=0;7>d;d+=1)r[d]&&r[d].events&&(O=O.concat(r[d].events));O.length>0&&(r.hasEvent=!0,f.placeAllDayEvents(O))}b(function(){g()})},f._refreshView=function(){var b,d,e=f.range.startTime,g=c.$parent.hideWeekend===!0?h(e,5):h(e,7),k="w";c.rows=i(e),c.dates=g,b=f.formatWeekTitle.indexOf(k),d=a(e,f.formatWeekTitle),-1!==b&&(d=d.replace(k,j(e))),c.$parent.title=d},f._getRange=function(a){var b=a.getFullYear(),d=a.getMonth(),e=a.getDate(),f=a.getDay(),g=new Date(b,d,c.hideWeekend?e-f+1:e-f),h=new Date(b,d,c.hideWeekend?e-f+6:e-f+7);return{startTime:g,endTime:h}},c.getHour=function(a){return 12===parseInt(c.timeMode,10)?12>k+a?(k+a===0?12:k+a)+"am":(k+a===12?k+a:k+a-12)+"pm":c.timeMode&&24!==parseInt(c.timeMode,10)?void 0:10>k+a?"0"+(k+a)+":00":k+a+":00"},f.refreshView()}}}]).directive("dayview",["dateFilter","$timeout",function(a,b){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/day.html",require:"^calendar",link:function(c,d,e,f){function g(){var a=d.children(),b=a[0].children[1],e=b.offsetWidth-b.clientWidth,f=a[1],g=f.offsetWidth-f.clientWidth,h=e||g||0;h>0&&(0>=e?c.allDayEventGutterWidth=h:c.allDayEventGutterWidth=0,0>=g?c.normalGutterWidth=h:c.normalGutterWidth=0)}function h(a){for(var b=[],c=new Date(a.getTime()),d=c.getHours(),e=c.getDate(),f=i;j>=f;f+=1)c.setHours(d+f),c.setDate(e),b.push({time:new Date(c.getTime())});return b}var i=c.dayStart&&parseInt(c.dayStart,10)?parseInt(c.dayStart,10):0,j=c.dayEnd&&parseInt(c.dayEnd,10)?parseInt(c.dayEnd,10):23;b(function(){g()}),f.mode={step:{days:1}},f._onDataLoaded=function(){var a,d,e=f.eventSource,h=e?e.length:0,k=f.range.startTime,l=f.range.endTime,m=-(new Date).getTimezoneOffset(),n=new Date(k.getTime()+60*m*1e3),o=new Date(l.getTime()+60*m*1e3),p=c.rows,q=[],r=36e5,s=.016,t=!1;if(p.hasEvent){for(d=i;j>=d;d+=1)p[d].events&&(p[d].events=null);p.hasEvent=!1}for(var u=0;h>u;u+=1){var v=e[u],w=new Date(v.startTime),x=new Date(v.endTime);if(v.allDay){if(n>=x||w>=o)continue;q.push({event:v})}else{if(k>=x||w>=l)continue;t=!0;var y;y=k>=w?0:(w-k)/r;var z;z=x>=l?(l-k)/r:(x-k)/r;var A=Math.floor(y),B=Math.ceil(z-s),C={event:v,startIndex:A,endIndex:B};a=p[A].events,a?a.push(C):(a=[],a.push(C),p[A].events=a)}}if(t){var D=[];for(d=i;j>d;d+=1)p[d].events&&(D=D.concat(p[d].events));D.length>0&&(p.hasEvent=!0,f.placeEvents(D))}c.allDayEvents=q,b(function(){g()})},f._refreshView=function(){var b=f.range.startTime;c.rows=h(b),c.allDayEvents=[],c.dates=[b],c.$parent.title=a(b,f.formatDayTitle)},f._getRange=function(a){var b=a.getFullYear(),c=a.getMonth(),d=a.getDate(),e=new Date(b,c,d),f=new Date(b,c,d+1);return{startTime:e,endTime:f}},c.getHour=function(a){return 12===parseInt(c.timeMode,10)?12>i+a?(i+a===0?12:i+a)+"am":(i+a===12?i+a:i+a-12)+"pm":c.timeMode&&24!==parseInt(c.timeMode,10)?void 0:10>i+a?"0"+(i+a)+":00":i+a+":00"},f.refreshView()}}}]);